<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">
    <title>sb3fix - fix corrupted Scratch projects</title>
    <meta name="description" content="sb3fix tries to fix corrupted Scratch 3 projects.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }

      body {
        max-width: 720px;
        margin: auto;
        padding: 0 8px;
      }
      summary {
        cursor: pointer;
      }

      .fixed-error-list {
        overflow-wrap: break-word;
      }

      .error {
        font-family: monospace;
        white-space: pre-wrap;
      }
      .log-container {
        margin: 12px 0;
      }
      .log-messages {
        box-sizing: border-box;
        width: 100%;
        height: 200px;
      }
    </style>
  </head>

  <body>
    <h1>sb3fix (early prototype)</h1>
    <p>Insert corrupted project files made with Scratch 3 or TurboWarp, and sb3fix will try to fix it.</p>
    <noscript><p>sb3fix requires JavaScript.</p></noscript>
    <p>
      <input class="file" type="file" accept=".sb3" multiple autocomplete="off">
    </p>

    <div class="output"></div>

    <h2>My file is still broken!</h2>
    <p>Please get your project to us so we can try to fix it for you. If you have a GitHub account, the easiest way is to <a href="https://github.com/TurboWarp/sb3fix/issues/new">open a GitHub issue</a> and attach your sb3 file.</p>

    <h2>Code</h2>
    <p>Open source on GitHub: <a href="https://github.com/TurboWarp/sb3fix">https://github.com/TurboWarp/sb3fix</a></p>

    <h2>Privacy</h2>
    <p>Files are processed locally on your computer and never sent to any server.</p>

    <h2>Which errors does this fix?</h2>
    <p>Some example error messages from TurboWarp that sb3fix addresses:</p>
    <ul class="fixed-error-list">
      <li><code>{"validationError":"Could not parse as a valid SB2 or SB3 project.","sb3Errors":[{"keyword":"type","dataPath":".targets[2].variables['32!k|mRA^e^r;{*i9Z[p-getParam,number1,r-'][0]","schemaPath":"#/items/0/type","params":{"type":"string"},"message":"should be string"}],"sb2Errors":[{"keyword":"required","dataPath":"","schemaPath":"#/required","params":{"missingProperty":"objName"},"message":"should have required property 'objName'"}]}</code></li>
      <li><code>{"validationError":"Could not parse as a valid SB2 or SB3 project.","sb3Errors":[{"keyword":"type","dataPath":".targets[1].costumes[0].name","schemaPath":"#/properties/name/type","params":{"type":"string"},"message":"should be string"}],"sb2Errors":[{"keyword":"required","dataPath":"","schemaPath":"#/required","params":{"missingProperty":"objName"},"message":"should have required property 'objName'"}]}</code></li>
      <li><code>{"validationError":"Could not parse as a valid SB2 or SB3 project.","sb3Errors":[{"keyword":"type","dataPath":".targets[1].sounds[0].name","schemaPath":"#/properties/name/type","params":{"type":"string"},"message":"should be string"}],"sb2Errors":[{"keyword":"required","dataPath":"","schemaPath":"#/required","params":{"missingProperty":"objName"},"message":"should have required property 'objName'"}]}</code></li>
      <li><code>{"validationError":"Could not parse as a valid SB2 or SB3 project.","sb3Errors":[{"keyword":"type","dataPath":".targets[2].blocks['b'].inputs['MESSAGE'][1]","schemaPath":"#/definitions/optionalString/oneOf/0/type","params":{"type":"string"},"message":"should be string"},{"keyword":"type","dataPath":".targets[2].blocks['b'].inputs['MESSAGE'][1]","schemaPath":"#/definitions/optionalString/oneOf/1/type","params":{"type":"null"},"message":"should be null"}, ...}],"sb2Errors":[{"keyword":"required","dataPath":"","schemaPath":"#/required","params":{"missingProperty":"objName"},"message":"should have required property 'objName'"}]}</code></li>
    </ul>
    <p>The best way to see if you're in luck is to just try it.</p>

    <script>
      /** @type {HTMLFileElement} */
      const input = document.querySelector('.file');
      /** @type {HTMLElement} */
      const output = document.querySelector('.output');

      // Start handling drag events as soon as possible
      document.addEventListener('dragover', (e) => {
        if (e.dataTransfer.types.includes('Files')) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
        }
      });
      document.addEventListener('drop', (e) => {
        if (e.dataTransfer.types.includes('Files')) {
          e.preventDefault();
          input.files = e.dataTransfer.files;
          input.dispatchEvent(new Event('change'));
        }
      });
    </script>

    <script src="dependencies/jszip.min.js"></script>
    <script src="sb3fix.js"></script>
    <script>
      const stringifyError = (error) => {
        if (error && error.message && error.stack) {
          return `${error.message}\n${error.stack}`;
        }
        return `${error}`;
      };

      const processFile = async (file) => {
        const container = document.createElement('div');
        output.appendChild(container);

        container.appendChild(Object.assign(document.createElement('h3'), {
          textContent: file.name
        }));

        const processingMessage = Object.assign(document.createElement('p'), {
          textContent: 'Processing...'
        });
        container.appendChild(processingMessage);

        const fixed = await sb3fix(file);

        container.removeChild(processingMessage);

        if (fixed.success) {
          const blob = new Blob([fixed.fixedZip], {
            type: 'application/x.scratch.sb3'
          });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `fixed ${file.name}`;
          link.textContent = `Download fixed ${file.name}`;
          container.appendChild(link);
        } else {
          const error = Object.assign(document.createElement('p'), {
            className: 'error',
            textContent: `ERROR: ${stringifyError(fixed.error)}`
          });
          container.appendChild(error);
        }

        const logContainer = Object.assign(document.createElement('details'), {
          className: 'log-container'
        });
        const logSummary = Object.assign(document.createElement('summary'), {
          className: 'log-summary',
          textContent: 'View log'
        });
        const logMessages = Object.assign(document.createElement('textarea'), {
          className: 'log-messages',
          readOnly: true,
          textContent: fixed.log.join('\n'),
          placeholder: '(empty)'
        });
        logContainer.appendChild(logSummary);
        logContainer.appendChild(logMessages);
        container.appendChild(logContainer);
      };

      const process = async () => {
        while (output.firstChild) {
          output.removeChild(output.firstChild);
        }
        for (const file of input.files) {
          await processFile(file);
        }
      };

      input.addEventListener('change', process);
      // Files might've been selected before JS finished loading
      if (input.files.length > 0) {
        process();
      }
    </script>
  </body>
</html>
